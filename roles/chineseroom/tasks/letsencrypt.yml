---
- name: Fail if AWS credentials are not configured
  fail:
    msg: |
      AWS credentials must be configured via:
        - chineseroom_aws_access_key_id
        - chineseroom_aws_secret_access_key
        - chineseroom_aws_region
      These are required for Let's Encrypt DNS validation via Route53.
  when: >
    chineseroom_aws_access_key_id == "" or
    chineseroom_aws_secret_access_key == "" or
    chineseroom_aws_region == ""

- name: Create AWS configuration directory
  file:
    path: /root/.aws
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: Configure AWS credentials
  copy:
    content: |
      [default]
      aws_access_key_id = {{ chineseroom_aws_access_key_id }}
      aws_secret_access_key = {{ chineseroom_aws_secret_access_key }}
    dest: /root/.aws/credentials
    owner: root
    group: root
    mode: '0600'

- name: Configure AWS region
  copy:
    content: |
      [default]
      region = {{ chineseroom_aws_region }}
    dest: /root/.aws/config
    owner: root
    group: root
    mode: '0600'

- name: Install required packages
  package:
    name:
      - certbot
      - python3-certbot-dns-route53
    state: present

- name: Check if certificate already exists
  stat:
    path: "{{ chineseroom_letsencrypt_base }}/live/{{ chineseroom_letsencrypt_domain }}/fullchain.pem"
  register: cert_exists

- name: Request Let's Encrypt certificate
  command: |
    certbot certonly
      --non-interactive
      --agree-tos
      --email {{ chineseroom_letsencrypt_email }}
      --dns-route53
      -d {{ chineseroom_letsencrypt_domain }}
      -d *.{{ chineseroom_letsencrypt_domain }}
  when: not cert_exists.stat.exists

- name: Create Let's Encrypt renewal hook directory
  file:
    path: "{{ chineseroom_letsencrypt_base }}/renewal-hooks/deploy"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create nginx reload hook for cert renewal
  copy:
    content: |
      #!/bin/sh
      systemctl reload nginx
    dest: "{{ chineseroom_letsencrypt_base }}/renewal-hooks/deploy/reload-nginx.sh"
    owner: root
    group: root
    mode: '0755'
