---
- name: Install Node.js and npm
  dnf:
    name:
      - nodejs
      - npm
    state: present

# https://docs.anthropic.com/en/docs/claude-code/troubleshooting#linux-permission-issues
- name: Create npm global directory
  file:
    path: "/home/{{ chineseroom_restricted_user }}/.local"
    state: directory
    owner: "{{ chineseroom_restricted_user }}"
    group: "{{ chineseroom_restricted_user }}"
    mode: '0755'

- name: Configure npm prefix for chineseroom user
  lineinfile:
    path: "/home/{{ chineseroom_restricted_user }}/.npmrc"
    line: 'prefix=/home/{{ chineseroom_restricted_user }}/.local'
    state: present
    owner: "{{ chineseroom_restricted_user }}"
    group: "{{ chineseroom_restricted_user }}"
    mode: '0644'
    create: yes

- name: Add npm global bin to PATH in bashrc
  lineinfile:
    path: "/home/{{ chineseroom_restricted_user }}/.bashrc"
    line: 'export PATH=~/.local/bin:$PATH'
    state: present
    owner: "{{ chineseroom_restricted_user }}"
    group: "{{ chineseroom_restricted_user }}"
    mode: '0644'
    create: yes

- name: Install Claude Code for chineseroom user
  become: yes
  become_user: "{{ chineseroom_restricted_user }}"
  npm:
    name: "@anthropic-ai/claude-code"
    global: yes
    state: present
  environment:
    PATH: "/home/{{ chineseroom_restricted_user }}/.local/bin:{{ ansible_env.PATH }}"
    npm_config_prefix: "/home/{{ chineseroom_restricted_user }}/.local"
  when: chineseroom_app_anthropic_claudecode_enable

- name: Create systemd user service directory for chineseroom user
  file:
    path: "/home/{{ chineseroom_restricted_user }}/.config/systemd/user"
    state: directory
    owner: "{{ chineseroom_restricted_user }}"
    group: "{{ chineseroom_restricted_user }}"
    mode: '0700'

- name: Add user service to update Claude Code
  copy:
    dest: "/home/{{ chineseroom_restricted_user }}/.config/systemd/user/claude-code-update.service"
    owner: "{{ chineseroom_restricted_user }}"
    group: "{{ chineseroom_restricted_user }}"
    mode: '0644'
    content: |
      [Unit]
      Description=Update Claude Code Oneshot
      [Service]
      Type=oneshot
      ExecStart=/usr/bin/npm install -g @anthropic-ai/claude-code
      Environment=PATH=/home/{{ chineseroom_restricted_user }}/.local/bin:{{ ansible_env.PATH }}
      Environment=npm_config_prefix=/home/{{ chineseroom_restricted_user }}/.local
  notify:
    - user daemon-reload
  when: chineseroom_app_anthropic_claudecode_autoupdate

- name: Add user timer to update Claude Code
  copy:
    dest: "/home/{{ chineseroom_restricted_user }}/.config/systemd/user/claude-code-update.timer"
    owner: "{{ chineseroom_restricted_user }}"
    group: "{{ chineseroom_restricted_user }}"
    mode: '0644'
    content: |
      [Unit]
      Description=Update Claude Code Timer
      [Timer]
      # Run nightly between 2 AM and 6 AM (with the delay)
      OnCalendar=*-*-* 02:00:00
      RandomizedDelaySec=4h
      # If the machine was off during a scheduled window, run once at next boot
      Persistent=true
      Unit=claude-code-update.service
      [Install]
      WantedBy=timers.target
  notify:
    - user daemon-reload
    - enable claude-code-update.timer
  when: chineseroom_app_anthropic_claudecode_autoupdate

# The default instructions assume Chrome is installed.
# Chrome is only installable on x86_64, and this role is meant to work on aarch64 as well, so we don't install it.
# Enable Playwright MCP and tell it to use Firefox instead.
- name: Install Playwright for Claude
  become: yes
  become_user: "{{ chineseroom_restricted_user }}"
  command: >
    claude mcp add playwright --scope user npx -- '@playwright/mcp@latest' --browser firefox
  environment:
    PATH: "/home/{{ chineseroom_restricted_user }}/.local/bin:{{ ansible_env.PATH }}"
  register: playwright_install
  failed_when: "'MCP server playwright already exists in user config' not in playwright_install.stderr and playwright_install.rc != 0"
  changed_when: "'MCP server playwright already exists in user config' not in playwright_install.stderr and playwright_install.rc == 0"
  when: chineseroom_app_playwright_enable

- name: Install OpenAI Codex CLI for chineseroom user
  become: yes
  become_user: "{{ chineseroom_restricted_user }}"
  npm:
    name: "@openai/codex"
    global: yes
    state: present
  environment:
    PATH: "/home/{{ chineseroom_restricted_user }}/.local/bin:{{ ansible_env.PATH }}"
    npm_config_prefix: "/home/{{ chineseroom_restricted_user }}/.local"
  when: chineseroom_app_openai_codex_enable

- name: Add user service to update OpenAI Codex CLI
  copy:
    dest: "/home/{{ chineseroom_restricted_user }}/.config/systemd/user/openai-codex-update.service"
    owner: "{{ chineseroom_restricted_user }}"
    group: "{{ chineseroom_restricted_user }}"
    mode: '0644'
    content: |
      [Unit]
      Description=Update OpenAI Codex CLI Oneshot
      [Service]
      Type=oneshot
      ExecStart=/usr/bin/npm install -g @openai/codex
      Environment=PATH=/home/{{ chineseroom_restricted_user }}/.local/bin:{{ ansible_env.PATH }}
      Environment=npm_config_prefix=/home/{{ chineseroom_restricted_user }}/.local
  notify:
    - user daemon-reload
  when: chineseroom_app_openai_codex_autoupdate

- name: Add user timer to update OpenAI Codex CLI
  copy:
    dest: "/home/{{ chineseroom_restricted_user }}/.config/systemd/user/openai-codex-update.timer"
    owner: "{{ chineseroom_restricted_user }}"
    group: "{{ chineseroom_restricted_user }}"
    mode: '0644'
    content: |
      [Unit]
      Description=Update OpenAI Codex CLI Timer
      [Timer]
      # Run nightly between 2 AM and 6 AM (with the delay)
      OnCalendar=*-*-* 02:00:00
      RandomizedDelaySec=4h
      # If the machine was off during a scheduled window, run once at next boot
      Persistent=true
      Unit=openai-codex-update.service
      [Install]
      WantedBy=timers.target
  notify:
    - user daemon-reload
    - enable openai-codex-update.timer
  when: chineseroom_app_openai_codex_autoupdate

- name: Install OpenClaw for chineseroom user
  become: yes
  become_user: "{{ chineseroom_restricted_user }}"
  npm:
    name: "openclaw@latest"
    global: yes
    state: present
  environment:
    PATH: "/home/{{ chineseroom_restricted_user }}/.local/bin:{{ ansible_env.PATH }}"
    npm_config_prefix: "/home/{{ chineseroom_restricted_user }}/.local"
  when: chineseroom_app_openclaw_enable
